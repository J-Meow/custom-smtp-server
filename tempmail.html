<!doctype html>
<html>
    <head>
        <title>Temporary Email</title>
        <meta charset="utf-8" />
        <style>
            html {
                background: black;
                font-family: sans-serif;
                color-scheme: dark;
                color: white;
            }
            #newEmail {
                cursor: pointer;
                background: none;
                border: none;
                text-decoration: underline;
            }
            #emails {
                list-style-type: none;
                padding: 0;
                margin: 0;
            }
            #emails li {
                border: 1px solid white;
                padding: 20px;
                margin: 0;
                border-radius: 20px;
            }
            #emails li h2 {
                margin-top: 0;
            }
            #emails li p {
                margin-bottom: 0;
            }
            details {
                color: #aaa;
                overflow-x: scroll;
            }
        </style>
    </head>
    <body>
        <h1>Temporary Email</h1>
        <p>
            Send emails to <code id="email">[loading...]</code> and see them
            appear here
        </p>
        <button id="newEmail">New email address</button>
        <h2>Emails:</h2>
        <ul id="emails"></ul>
        <script>
            fetch("/getEmail")
                .then((res) => res.text())
                .then((email) => {
                    document.getElementById("email").innerText = email
                })
            const receivedEmailIds = []
            function loadEmails() {
                fetch("/emails")
                    .then((res) => res.json())
                    .then((emails) => {
                        console.log(emails)
                        emails.forEach((email) => {
                            if (receivedEmailIds.includes(email.id)) {
                                return
                            }
                            receivedEmailIds.push(email.id)
                            const li = document.createElement("li")
                            const subject = document.createElement("h2")
                            subject.innerText = email.subject
                            li.appendChild(subject)
                            const from = document.createElement("p")
                            from.innerText = "From: " + email.from
                            li.appendChild(from)
                            const details = document.createElement("details")
                            details.innerHTML = "<summary>Headers</summary>"
                            const headers = document.createElement("pre")
                            headers.innerText = Object.keys(email.headers)
                                .map(
                                    (headerName) =>
                                        `${headerName}: ${email.headers[headerName]}`,
                                )
                                .join("\n")
                            details.appendChild(headers)
                            li.appendChild(details)
                            const bodyHeader = document.createElement("h3")
                            bodyHeader.innerText = "Raw content:"
                            li.appendChild(bodyHeader)
                            const body = document.createElement("p")
                            body.innerText = email.body
                            li.appendChild(body)
                            document.getElementById("emails").appendChild(li)
                        })
                    })
            }
            loadEmails()
            setInterval(loadEmails, 3000)
            document
                .getElementById("newEmail")
                .addEventListener("click", () => {
                    if (
                        !confirm(
                            "New email? This will erase all emails sent to this address",
                        )
                    )
                        return
                    fetch("/newEmail", { method: "POST" }).then(() =>
                        location.reload(),
                    )
                })
        </script>
    </body>
</html>
